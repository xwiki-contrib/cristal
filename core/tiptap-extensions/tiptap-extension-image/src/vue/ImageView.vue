<!--
  See the LICENSE file distributed with this work for additional
  information regarding copyright ownership.

  This is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation; either version 2.1 of
  the License, or (at your option) any later version.

  This software is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public
  License along with this software; if not, write to the Free
  Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->
<script setup lang="ts">
import { NodeViewWrapper } from "@tiptap/vue-3";
import { computed, ref } from "vue";
import Vue3DraggableResizable from "vue3-draggable-resizable";
import type { NodeViewProps } from "@tiptap/vue-3";
import type { Ref } from "vue";

const { node, updateAttributes } = defineProps<NodeViewProps>();

const src = computed(() => {
  return node.attrs.src;
});

const alt = computed(() => {
  return node.attrs.alt;
});

type ImageDimensions = { width: number; height: number };

async function computeImageSize(src: string): Promise<ImageDimensions> {
  const img = new Image();

  let resolve;
  let reject;

  // eslint-disable-next-line promise/param-names
  const p: Promise<ImageDimensions> = new Promise((res, rej) => {
    resolve = res;
    reject = rej;
  });

  img.onload = () => {
    resolve!({ width: img.width, height: img.height });
  };

  img.onerror = () => {
    reject!();
  };

  img.src = src;

  return p;
}

const loading: Ref<boolean> = ref(true);
const imageLoadingError: Ref<string | undefined> = ref(undefined);
const originalImageDimensions: Ref<ImageDimensions | undefined> =
  ref(undefined);
const hasChanged = ref(false);

// eslint-disable-next-line promise/catch-or-return
computeImageSize(node.attrs.src)
  // eslint-disable-next-line promise/always-return
  .then((dimensions) => {
    originalImageDimensions.value = recompute(dimensions);
  })
  .catch(() => {})
  .finally(() => (loading.value = false));

const w = computed({
  get() {
    return node.attrs.width ?? originalImageDimensions.value?.width;
  },
  set(value) {
    updateAttributes({
      width: value,
    });
  },
});
const h = computed({
  get() {
    return node.attrs.height ?? originalImageDimensions.value?.height;
  },
  set(value) {
    updateAttributes({
      height: value,
    });
  },
});

const isActive = defineModel<boolean>("isActive", { default: false });

function setActive() {
  isActive.value = true;
}

const computedStyle = computed(() => {
  if (!hasChanged.value) {
    return {
      width: `${originalImageDimensions.value?.width}px`,
      height: `${originalImageDimensions.value?.height}px`,
    };
  } else {
    return {};
  }
});

function recompute({ width, height }: ImageDimensions) {
  const maxWidth = 960;

  if (width > maxWidth) {
    const ratio = width / maxWidth;
    width = maxWidth;
    height = height / ratio;
  }
  return { width, height };
}

function onResize({ w: wp, h: hp }: { w: number; h: number }) {
  const { width, height } = recompute({ width: wp, height: hp });
  w.value = width;
  h.value = height;
  hasChanged.value = true;
}
</script>
<template>
  <node-view-wrapper>
    <div @click="setActive">
      <div v-if="loading">Loading...</div>
      <div v-else-if="imageLoadingError !== undefined">
        {{ imageLoadingError }}
      </div>
      <div v-else class="image-container" :style="computedStyle">
        <!-- Resizing is currently deactivated as no backend supports it -->
        <vue3-draggable-resizable
          v-model:active="isActive"
          :parent="true"
          :draggable="false"
          :resizable="false"
          :h="h"
          :w="w"
          :handles="['br']"
          :lock-aspect-ratio="true"
          @resize-end="onResize"
        >
          <img :src="src" :alt="alt" class="img" />
        </vue3-draggable-resizable>
      </div>
    </div>
  </node-view-wrapper>
</template>

<style scoped>
.img {
  width: 100%;
  height: 100%;
}

.image-container,
.image-container > div {
  position: relative;
  display: block;
}
</style>
